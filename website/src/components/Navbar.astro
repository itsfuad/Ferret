---
// Shared Navbar Component
import ferretLogo from "../assets/ferret.webp";

import SearchBar from "./CustomSearch.astro";

import type { StarlightRouteData } from "@astrojs/starlight/route-data";

interface NavbarProps extends StarlightRouteData {
    showSearch?: boolean;
    showPlayground?: boolean;
}

const { showSearch = false, showPlayground = true } =
    Astro.props as NavbarProps;

// Get current path to conditionally show/hide nav items
const currentPath = Astro.url.pathname;
const isHome =
    currentPath === "/" ||
    currentPath === "/index" ||
    currentPath === "/index/";
const isPlayground = currentPath.startsWith("/play");
const isBlog = currentPath.startsWith("/blog");
const isDocs = !isHome && !isPlayground && !isBlog;
---

<nav class="navbar">
    <div class="navbar-left">
        <a href="/" class="navbar-logo">
            <img src={ferretLogo.src} alt="Ferret" />
        </a>
    </div>

    <div class="navbar-right">
        {showSearch && <SearchBar />}

        {/* Show blogs link */}
        {
            !isBlog && (
                <a href="/blog" class="nav-link">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M12 20h9" />
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z" />
                    </svg>
                    <span>Blogs</span>
                </a>
            )
        }

        {/* Show "Docs" link only when NOT on docs pages */}
        {
            !isDocs && (
                <a href="/getting-started/introduction/" class="nav-link">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M2 4h9a2 2 0 0 1 2 2v14a2 2 0 0 0-2-2H2z" />
                        <path d="M22 4h-9a2 2 0 0 0-2 2v14a2 2 0 0 1 2-2h9z" />
                    </svg>
                    <span>Docs</span>
                </a>
            )
        }

        {/* Show "Playground" link only when NOT on playground page */}
        {
            !isPlayground && showPlayground && (
                <a href="/play" class="nav-link">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    <span>Playground</span>
                </a>
            )
        }

        <button
            class="theme-toggle"
            id="theme-toggle"
            aria-label="Toggle theme"
        >
            <!-- Sun icon for light theme -->
            <svg
                class="theme-icon light-icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <circle cx="12" cy="12" r="4"></circle>
                <path
                    d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"
                ></path>
            </svg>
            <!-- Moon icon for dark theme -->
            <svg
                class="theme-icon dark-icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
            >
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                ></path>
            </svg>
        </button>

        <a
            href="https://github.com/itsfuad/Ferret"
            target="_blank"
            rel="noopener noreferrer"
            class="nav-link"
            aria-label="GitHub"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="currentColor"
            >
                <path
                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                ></path>
            </svg>
        </a>

        {/* Mobile menu button (only on docs pages) */}
        {
            isDocs && (
                <button
                    class="mobile-menu-toggle"
                    id="mobile-menu-toggle"
                    aria-label="Toggle sidebar"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <line x1="3" y1="12" x2="21" y2="12" />
                        <line x1="3" y1="6" x2="21" y2="6" />
                        <line x1="3" y1="18" x2="21" y2="18" />
                    </svg>
                </button>
            )
        }
    </div>
</nav>

<style>
    /* Navbar matching Starlight style */
    .navbar {
        position: sticky;
        top: 0;
        max-height: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 2rem;
        background: var(--background);
        border-bottom: 1px solid var(--border);
        z-index: 100;
        box-sizing: border-box;
        line-height: 1;
    }

    a[href="/getting-started/introduction/"] {
        text-decoration: none;
        color: var(--accent-color) !important;
    }

    .navbar-left {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 5px 0;
    }

    .navbar-logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.125rem;
        color: var(--accent-color);
        transition: opacity 0.15s ease;
    }

    .navbar-logo:hover {
        opacity: 0.8;
    }

    .navbar-logo img {
        width: 2rem;
        height: 2rem;
        object-fit: contain;
    }

    .navbar-right {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: nowrap;
        width: 100%;
        justify-content: flex-end;
        min-width: 0;
    }

    .nav-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.875rem;
        color: var(--muted-foreground);
        text-decoration: none;
        border-radius: 0.5rem;
        transition: all 0.15s ease;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
        line-height: 1;
    }

    .nav-link:hover {
        background: var(--muted);
        color: var(--foreground);
    }

    /* Theme toggle button */
    .theme-toggle {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border);
        background: var(--background);
        transition: all 150ms ease;
        color: var(--muted-foreground);
    }

    .theme-toggle:hover {
        background: var(--muted);
        color: var(--foreground);
    }

    .theme-toggle:focus-visible {
        outline: 2px solid var(--accent-color);
        outline-offset: 2px;
    }

    .theme-icon {
        width: 1.125rem;
        height: 1.125rem;
        transition: all 150ms ease;
    }

    :global([data-theme="light"]) .dark-icon {
        display: none;
    }

    :global([data-theme="dark"]) .light-icon {
        display: none;
    }

    /* Mobile menu toggle button */
    .mobile-menu-toggle {
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        border: none;
        background: transparent;
        color: var(--foreground);
        cursor: pointer;
        border-radius: 0.5rem;
        transition: background 0.15s ease;
    }

    .mobile-menu-toggle:hover {
        background: var(--muted);
    }

    .mobile-menu-toggle svg {
        width: 1.5rem;
        height: 1.5rem;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .navbar {
            padding-right: 0.5rem;
            padding-left: 0.5rem;
            transition: padding 0.3s ease-in-out;
        }

        /* Show mobile menu button only on small screens */
        .mobile-menu-toggle {
            display: flex;
        }

        .navbar-logo {
            font-size: 1rem;
        }

        .navbar-logo img {
            width: 1.75rem;
            height: 1.75rem;
        }

        .navbar-right {
            gap: 0.5rem;
        }

        .nav-link {
            padding: 0.375rem 0.625rem;
            font-size: 0.8125rem;
        }

        .nav-link span {
            display: none;
        }

        .theme-toggle {
            padding: 0.375rem;
        }

        .theme-icon {
            width: 1rem;
            height: 1rem;
        }
    }
</style>

<script>
    // Theme system matching Starlight's implementation
    type Theme = "dark" | "light";

    const parseTheme = (theme: unknown): Theme =>
        theme === "light" ? "light" : "dark";

    function setTheme(theme: Theme): void {
        document.documentElement.dataset.theme = theme;
        localStorage.setItem("starlight-theme", theme);
    }

    function toggleTheme(current: Theme): Theme {
        return current === "dark" ? "light" : "dark";
    }

    // Initialize theme from localStorage
    const savedTheme = parseTheme(localStorage.getItem("starlight-theme"));
    setTheme(savedTheme);

    // Theme toggle handler
    const themeToggle = document.getElementById("theme-toggle");
    themeToggle?.addEventListener("click", () => {
        const current = parseTheme(localStorage.getItem("starlight-theme"));
        const next = toggleTheme(current);
        setTheme(next);
    });

    // Keep Starlight's layout offsets in sync with our navbar height (docs pages).
    // This avoids "almost matching" heights across docs vs standalone pages.
    function syncStarlightNavHeight(): void {
        const navbar = document.querySelector<HTMLElement>(".navbar");
        if (!navbar) return;

        const setVar = () => {
            const height = navbar.getBoundingClientRect().height;
            if (height > 0) {
                document.documentElement.style.setProperty(
                    "--sl-nav-height",
                    `${Math.round(height)}px`,
                );
            }
        };

        setVar();
        // Recompute when content changes (e.g. search UI, responsive breakpoints).
        const ro = new ResizeObserver(() => setVar());
        ro.observe(navbar);
        window.addEventListener("orientationchange", setVar, { passive: true });
    }

    // Run after initial layout to get accurate measurements.
    requestAnimationFrame(syncStarlightNavHeight);

    // Mobile menu toggle handler (navbar button)
    const mobileMenuToggle = document.getElementById("mobile-menu-toggle");
    mobileMenuToggle?.addEventListener("click", () => {
        // Toggle Starlight's sidebar
        const menuButton = document.querySelector("starlight-menu-button");
        if (menuButton) {
            const button = menuButton.querySelector("button");
            button?.click();
        }
    });
</script>
